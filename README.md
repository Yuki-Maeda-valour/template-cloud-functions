# ğŸš€ Lean Cloud Functions Architecture Template

Google Cloud Functionsç”¨ã®è»½é‡ã§æ‹¡å¼µå¯èƒ½ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚

## âœ¨ ç‰¹å¾´

- **è–„ã„index.ts**: æ¥­å‹™ãƒ­ã‚¸ãƒƒã‚¯ãªã—ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ«ãƒ¼ã‚¿ãƒ¼
- **é–¢æ•°ã®ç‹¬ç«‹æ€§**: å„é–¢æ•°ãŒå®Œå…¨ã«ç‹¬ç«‹ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«
- **è‡ªå‹•æ¤œå‡º**: æ–°ã—ã„é–¢æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•èªè­˜
- **ç°¡å˜ãªè¿½åŠ **: 1ã‚³ãƒãƒ³ãƒ‰ã§æ–°é–¢æ•°ä½œæˆ
- **å€‹åˆ¥ãƒ†ã‚¹ãƒˆ**: é–¢æ•°ã”ã¨ã«ç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆå¯èƒ½
- **ãƒ–ãƒ©ã‚¦ã‚¶ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**: è¦–è¦šçš„ãªé–‹ç™ºç’°å¢ƒ

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
template-cloud-functions/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                    # è–„ã„ãƒ«ãƒ¼ã‚¿ãƒ¼ï¼ˆè‚¥å¤§åŒ–ã—ãªã„ï¼‰
â”‚   â”œâ”€â”€ functions/                  # å€‹åˆ¥é–¢æ•°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”‚   â”‚   â”œâ”€â”€ check-unread-emails.ts    # æœªèª­ãƒ¡ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
â”‚   â”‚   â”œâ”€â”€ send-daily-report.ts      # æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡
â”‚   â”‚   â”œâ”€â”€ backup-drive-files.ts     # Driveãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
â”‚   â”‚   â”œâ”€â”€ clean-old-files.ts        # å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
â”‚   â”‚   â””â”€â”€ update-spreadsheet.ts     # ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›´æ–°
â”‚   â”œâ”€â”€ shared/                     # å…±é€šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ gmail-service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ drive-service.ts
â”‚   â”‚   â”‚   â””â”€â”€ sheets-service.ts
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ oauth-manager.ts
â”‚   â”‚   â”‚   â””â”€â”€ cloud-auth.ts
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚       â”œâ”€â”€ logger.ts
â”‚   â”‚       â””â”€â”€ function-registry.ts
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ function.ts
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ dev-server.ts              # é–‹ç™ºç”¨ã‚µãƒ¼ãƒãƒ¼
â”‚   â”œâ”€â”€ test-runner.ts             # é–¢æ•°ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼
â”‚   â””â”€â”€ function-creator.ts        # æ–°é–¢æ•°ä½œæˆãƒ„ãƒ¼ãƒ«
â””â”€â”€ package.json
```

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install
```

### 2. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

```bash
cp env.example .env
# .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦èªè¨¼æƒ…å ±ã‚’è¨­å®š
```

å¿…è¦ãªç’°å¢ƒå¤‰æ•°:
- `GOOGLE_CLIENT_ID`: Google OAuth ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID
- `GOOGLE_CLIENT_SECRET`: Google OAuth ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ
- `GOOGLE_REFRESH_TOKEN`: Google OAuth ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³
- `GOOGLE_CLOUD_PROJECT`: Google Cloud ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID

### 3. ãƒ“ãƒ«ãƒ‰

```bash
npm run build
```

## ğŸ§ª ä½¿ç”¨æ–¹æ³•

### æ–°ã—ã„é–¢æ•°ã‚’ä½œæˆ

```bash
# é–¢æ•°ä½œæˆ
npm run create my-new-function "My function description"

# ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†
# src/functions/my-new-function.ts
```

### é–‹ç™ºã¨ãƒ†ã‚¹ãƒˆ

```bash
# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä»˜ãï¼‰
npm run dev

# é–¢æ•°ä¸€è¦§è¡¨ç¤º
npm run test list

# ç‰¹å®šã®é–¢æ•°ã‚’ãƒ†ã‚¹ãƒˆ
npm run test test check-unread-emails

# å…¨é–¢æ•°ã‚’ãƒ†ã‚¹ãƒˆ
npm run test test-all
```

### é–¢æ•°å®Ÿè¡Œ

```bash
# HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆå½¢å¼
curl -X POST http://localhost:8080 \
  -H "Content-Type: application/json" \
  -d '{"functionName": "check-unread-emails", "test": true}'

# å€‹åˆ¥ãƒ†ã‚¹ãƒˆå½¢å¼
curl -X POST http://localhost:8080/test/check-unread-emails \
  -H "Content-Type: application/json" \
  -d '{"test": true}'
```

## ğŸŒ é–‹ç™ºãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:8080` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã™ï¼š

- åˆ©ç”¨å¯èƒ½ãªé–¢æ•°ã®ä¸€è¦§è¡¨ç¤º
- å„é–¢æ•°ã®å€‹åˆ¥ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- ãƒ†ã‚¹ãƒˆçµæœã®è¡¨ç¤º
- é–¢æ•°ã®èª¬æ˜ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ±

## ğŸ“¦ ãƒ‡ãƒ—ãƒ­ã‚¤

### Google Cloud Functions ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# ãƒ“ãƒ«ãƒ‰
npm run build

# ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆgcloud CLIãŒå¿…è¦ï¼‰
gcloud functions deploy httpHandler \
  --runtime nodejs20 \
  --trigger-http \
  --allow-unauthenticated
```

### Cloud Run ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# ãƒ“ãƒ«ãƒ‰
npm run build

# ãƒ‡ãƒ—ãƒ­ã‚¤
gcloud run deploy my-function \
  --source . \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated
```

## ğŸ”§ åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆ

- `npm run build`: TypeScriptã‚³ãƒ¼ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰
- `npm run dev`: é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
- `npm run start`: æœ¬ç•ªç”¨ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
- `npm run test`: ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã‚’å®Ÿè¡Œ
- `npm run create`: æ–°ã—ã„é–¢æ•°ã‚’ä½œæˆ
- `npm run gcp-build`: Google Cloud Functionsç”¨ãƒ“ãƒ«ãƒ‰

## ğŸ“ é–¢æ•°ã®è¿½åŠ æ–¹æ³•

1. **é–¢æ•°ä½œæˆãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨**:
   ```bash
   npm run create my-function "Function description"
   ```

2. **æ‰‹å‹•ã§ä½œæˆ**:
   - `src/functions/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
   - `CloudFunction` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…
   - `config` ã¨ `handler` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å®šç¾©

3. **è‡ªå‹•èªè­˜**:
   - æ–°ã—ã„é–¢æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã¯è‡ªå‹•çš„ã«ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ç™»éŒ²ã•ã‚Œã‚‹
   - index.tsã®å¤‰æ›´ã¯ä¸è¦

## ğŸ¯ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åˆ©ç‚¹

1. **index.tsãŒè‚¥å¤§åŒ–ã—ãªã„**: è–„ã„ãƒ«ãƒ¼ã‚¿ãƒ¼ã®ã¿
2. **é–¢æ•°ã®ç‹¬ç«‹æ€§**: å„é–¢æ•°ãŒå®Œå…¨ã«ç‹¬ç«‹ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«
3. **ç°¡å˜ãªè¿½åŠ **: 1ã‚³ãƒãƒ³ãƒ‰ã§æ–°é–¢æ•°ä½œæˆ
4. **å€‹åˆ¥ãƒ†ã‚¹ãƒˆ**: é–¢æ•°ã”ã¨ã«ç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆå¯èƒ½
5. **è‡ªå‹•æ¤œå‡º**: æ–°ã—ã„é–¢æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•èªè­˜
6. **ãƒ–ãƒ©ã‚¦ã‚¶ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**: è¦–è¦šçš„ãªé–‹ç™ºç’°å¢ƒ
